---
# Copyright Â©2017-2025  Mr MXF   info@mrmxf.com
# BSD-3-Clause License           https://opensource.org/license/bsd-3-clause/
#       _                  _                                 _____
#    __| |   ___   _ __   | |   ___    _   _           ___  |___ /
#   / _` |  / _ \ | '_ \  | |  / _ \  | | | |  _____  / __|   |_ \
#  | (_| | |  __/ | |_) | | | | (_) | | |_| | |_____| \__ \  ___) |
#   \__,_|  \___| | .__/  |_|  \___/   \__, |         |___/ |____/
#                 |_|                  |___/
#  Callable GitHub action to deploy to an s3 bucket
#
# see on.workflow_call.inputs for params

name: deploy-s3
run-name: ${{ github.workflow }}(${{ github.event_name }}) ðŸ¥·${{ github.actor }}

# default env
env:
  depth: 1                       # default checkout depth 1
  ref: ${{ github.ref }}         # default checkout ref
  repo: ${{ github.repository }} # repo to checkout from
  url: ""                        # url of the repo for logging

on:
  workflow_call:
    inputs:
      artifact-name:         # artifact filename (absent = no artifacts)
        required: true
        type: string
      make:                  # MAKE-"deploy-s3" override the clog deploy settings
        required: false
        type: string
      bcTitle:               # slack notify: the pop up toast message
        required: false
        type: string
      bcMd:                  # slack notify: extra markdown for message
        required: false
        type: string
    secrets:
      get_clog:              # CLI to get the required version of clog
        required: true
      webhook_slack:         # webhook stub to a slack channel
        required: false
      aws_access_key_id:     # aws key identifier
        required: false
      aws_secret_access_key: # aws key value
        required: false
      s3_bucket:
        required: true

jobs:
  deploy-s3:
    # don't let random strangers run the PR workflows.
    if: ${{ contains(fromJSON('["mrmxf"]'), github.event.sender.login) || github.event_name == 'schedule' }}
    runs-on: ubuntu-latest

    steps:
      - # ---------------------------------------------------------------------
        id: init-clog
        name: init clog
        run: |
          # install clog & set up some of the funky build logic
          [ -z "${{ secrets.get_clog }}" ] && echo "GET_CLOG" secret not set && exit 1
          eval "${{ secrets.get_clog }}"
          depth=1

          case "${{ github.event_name }}" in

          "pull_request_target")
            # for a PR we checkout the latest pushed commit of the requesting repo
            verb="PR"
            clog BC stashLog -1 ${{ github.job }} -2 ${{ github.action }} -3 verb -I "$verb workflow from event ${{ github.event_name }}"
            ref="${{ github.event.pull_request.head.sha }}"            # head of the PR commits
            repo="${{ github.event.pull_request.head.repo.full_name }}" # head name
            url="${{ github.event.pull_request.head.repo.html_url }}"  # head url
            ;;

          "push" | "workflow_dispatch")
            # for a PUSH we checkout the HEAD of main
            verb="PUSH"
            clog BC stashLog -1 ${{ github.job }} -2 ${{ github.action }} -3 verb -I "$verb workflow from event ${{ github.event_name }}"
            ref="${{ github.ref }}"                                    # event trigger
            repo="${{ github.repository }}"                             # event repo
            url="${{ github.event.repository.html_url }}"              # event human url
            ;;

          "schedule")
            # for a SCHEDULE we checkout the latest production tag on main branch
            verb="SCHEDULE"
            clog BC stashLog -1 ${{ github.job }} -2 ${{ github.action }} -3 verb -I "$verb $verb workflow from event ${{ github.event_name }}"
            ref="main"               # cannot evaluate the production tag until after checkout
            repo="${{ github.repository }}"                             # production repo
            url="${{ github.event.repository.html_url }}"              # production human url
            depth=0
            ;;

          esac

          echo "verb=$verb"   >> $GITHUB_ENV
          echo "depth=$depth" >> $GITHUB_ENV
          echo "ref=$ref"     >> $GITHUB_ENV
          echo "repo=$repo"   >> $GITHUB_ENV
          echo "url=$url"     >> $GITHUB_ENV

          clog BC stashLog -1 ${{ github.job }} -2 ${{ github.action }} -3 status -I "verb=$verb, fetch-depth=$depth, checkout=$ref, repo=$repo, url=$url"
      - # ---------------------------------------------------------------------
        id: checkout
        name: checkout repo @ ${{ env.ref }}"
        uses: actions/checkout@v4
        with:
          fetch-depth: ${{ env.depth }}
          lfs: true
          ref: ${{ env.ref }}
          repository: ${{ env.repo }}
          submodules: recursive
      - # ---------------------------------------------------------------------
        id: artifacts
        name: artifact(${{ inputs.artifact-name }}) â†’ tmp/
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: tmp
      - # ---------------------------------------------------------------------
        id: docker
        if: inputs.docker_ns != '' # ignore if no namespace, fail if _pat empty
        name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{  inputs.docker_ns }}
          password: ${{ secrets.docker_pat }}
      - # ---------------------------------------------------------------------
        id: deploy-s3
        name: deploy artifacts to s3 with clog
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.aws_access_key_id }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.aws_secret_access_key }}
          S3_BUCKET: ${{ secrets.s3_bucket }}
          MAKE: ${{ inputs.make }}
        run: |
          if [ -z "$MAKE" ]; then 
            # use the standard build if no overrides
            clog deploy
          else
            clog BC stashLog -1 ${{ github.job }} -2 ${{ github.action }} -3 verb -W "$verb deploy override provided \$MAKE=\"$MAKE\""
            clog deploy MAKE "$MAKE"
          fi
      - # ---------------------------------------------------------------------
        id: notify
        name: notify-team
        env:
          # webhook_slack may be empty - no logging
          bcTitle: ${{ inputs.bcTitle }}
          HOOK_SLACK: ${{ secrets.webhook_slack }}
        run: |
          if [ -z "$HOOK_SLACK" ]; then
            clog BC stashLog -1 ${{ github.job }} -2 ${{ github.action }} -3 no-hook -W "HOOK_SLACK is empty - skipping Slack notification"
            exit 0
          fi

          stash="$(clog BC stash get path)"
          echo "â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“â‡“"
          cat "$stash"                        # log the stash file
          echo "â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘â‡‘"

          # append some extra info
          md=""
          md="$mdâ€¢ job ${{ github.job }}  from  $(basename ${{ github.workflow_ref }} | cut -d'@' -f1)\n"
          md="$mdâ€¢ repo ${{ env.repo }} at ${{ env.url }}\n"
          md="$mdâ€¢ checkout ref ${{ env.ref }} depth ${{ env.depth }}\n"
          md="$mdâ€¢ workflow ref: ${{ github.workflow_ref }}\n"

          # parse the Stash Yaml and make a pretty Slack message
          clog SlackStash "$bcTitle" --md "$md"
          clog Log -I "done"
